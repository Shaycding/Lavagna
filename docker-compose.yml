version: "3.8"

services:
  db:
    image: mysql:5.7
    container_name: lavagna-mysql
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - lavagna-mysql-data:/var/lib/mysql
    networks:
      - mysql-network

  lavagna:
    build:
      context: .
      dockerfile: light.Dockerfile
    container_name: lavagna-app
    depends_on:
      - db
    environment:
      # Tell Lavagna to use MySQL instead of HSQLDB
      LAVAGNA_DB_DIALECT: ${LAVAGNA_DB_DIALECT}
      LAVAGNA_DB_HOST: ${LAVAGNA_DB_HOST}
      LAVAGNA_DB_PORT: ${LAVAGNA_DB_PORT}
      LAVAGNA_DB_URL: ${LAVAGNA_DB_URL}
      LAVAGNA_DB_USERNAME: ${LAVAGNA_DB_USERNAME}
      LAVAGNA_DB_PASSWORD: ${LAVAGNA_DB_PASSWORD}

      # Spring profile & port
      LAVAGNA_SPRING_PROFILE: ${LAVAGNA_SPRING_PROFILE}
      LAVAGNA_PORT: ${LAVAGNA_PORT}
    networks:
      - nginx-network
      - mysql-network

  nginx:
    image: nginx:alpine
    container_name: lavagna-nginx
    depends_on:
      - lavagna
    ports:
      - "${NGINX_HTTP_PORT}:80"
      - "${NGINX_EXTRA_PORT}:8081"
    volumes:
      - ./nginx-lavagna.conf:/etc/nginx/conf.d/default.conf:ro
      - ./src/main/webapp:/var/www/lavagna/webapp:ro
      - ./target/lavagna/help:/var/www/lavagna/help:ro
    networks:
      - nginx-network

volumes:
  lavagna-mysql-data:   # MySQL persistence
  lavagna-data:         # optional app data (HSQLDB, logs, etc.)

networks:
  nginx-network:
  mysql-network:

